import json

def responder(pergunta, area):
    prompt = montar_prompt(pergunta, area)
    resposta = client.chat.completions.create(
        model=modelo,
        messages=[
            {"role": "system", "content": f"Você é um especialista em Direito {area} Brasileiro."},
            {"role": "user", "content": prompt}
        ],
        temperature=0.3,
        max_tokens=1200
    )

    conteudo = resposta.choices[0].message.content.strip()
    tokens_input = resposta.usage.prompt_tokens
    tokens_output = resposta.usage.completion_tokens

    # ✅ REGISTRO DO LOG
    log = {
        "user": "admin@cerizze.com",  # será dinâmico após login
        "area": area,
        "pergunta": pergunta,
        "resposta": conteudo,
        "modelo": modelo,
        "tokens_input": tokens_input,
        "tokens_output": tokens_output,
        "data": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    }

    os.makedirs("data", exist_ok=True)
    with open("data/interacoes.jsonl", "a") as f:
        f.write(json.dumps(log) + "\n")

    return conteudo
